<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	"http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<link rel="stylesheet" type="text/css" href="../layout/second.css"/>
	<link rel="stylesheet" type="text/css" href="../layout/mac_classic.css"/>
</head>
<body>
	<div class="frontcover"></div>

	<div class="halftitlepage">
		<h1 class="no-toc">Ruby on Rails 2.1</h1>
		<h2 class="no-toc">What's New</h2>
		<h3 class="no-toc">Second Edition</h3>
	</div>

	<div class="titlepage">
	<h1 class="no-toc">Ruby on Rails 2.1</h1>

	<h2 class="no-toc">What's New</h2>
	<h3 class="no-toc">Second Edition</h3>

	<p class="no-toc">Carlos Brando<br/>Marcos Tapajós</p>
	<!-- also, the publisher's name would typically be printed here -->
	</div>
	
	<div class="imprint">
		<p>&copy; Copyright 2008 Carlos Brando. All Rights Reserved.</p>
		<br/>
		<p>Second edition: June 2008</p>
		<br/>
		<p>Carlos Brando<br/>Website: www.nomedojogo.com</p>
		<p>Marcos Tapajós<br/>Website: www.improveit.com.br/en/company/tapajos</p>
	</div>
	
	<!-- <div class="toc">
		<h1>Sumário</h1>
		#toc
	</div> -->
	
	<div class="chapter">
		<h1>Introdução</h1>

<p>Por volta do mês de julho de 2004 David Heinemeier Hansson lançou publicamente o framework Ruby on Rails, que havia sido extraído de um software chamado Basecamp. Mais de três anos depois, no dia 7 de dezembro de 2007 o Ruby on Rails chegou a sua versão 2.0 com diversas alterações importantes.</p>

<p>De lá para cá se passaram seis meses, e neste tempo mais de <strong>1400 programadores</strong> do mundo todo contribuiram criando <strong>1600 patches</strong>. E hoje, 1 de junho de 2008 o Ruby on Rails chega à sua versão 2.1.</p>

<p>De acordo com David as principais novidades nesta versão são:</p>

<ul>
<li>Timezones</li>
<li>Dirty tracking</li>
<li>Gem Dependencies</li>
<li>Named scope</li>
<li>UTC-based migrations</li>
<li>Better caching</li>
</ul>


<p>Para atualizar ou instalar a nova versão, é o de sempre:</p>

<pre class="mac_classic">gem install rails
</pre>

<h2>Agradecimentos</h2>

<p>Ao Marcos Tapajós que é o co-autor deste livro. Se não fosse por ele acho que você não estaria lendo isto.</p>

<p>Ao Daniel Lopes que fez uma linda capa para esta edição.</p>

<p>A toda a comunidade brasileira de Ruby on Rails que colaborou direta ou indiretamente com este livro, comentando os textos no blog e dando sugestões. É como sempre costumo dizer, o melhor do Rails é a comunidade! Continuem criando, inventando e principalmente compartilhando...</p>

<h1> ActiveRecord</h1>

<p>O Active Record é uma camada de mapeamento objeto-relacional (object-relational mapping layer), responsável pela interoperabilidade entre a aplicação e o banco de dados e pela abstração dos dados.
(wikipedia)</p>

<h2> Uma nova forma de especificar conditions usando Hash</h2>

<p>Ao realizar buscas no banco de dados, por vezes temos de fazer uso da opção <strong>:joins</strong> afim de melhorar a performance de nosso aplicativo, em outros casos precisamos simplesmente recuperar algum tipo de informação que depende do resultado de duas tabelas.</p>

<p>Por exemplo, se desejássemos recuperar todos os usuários do sistema que compraram itens da cor vermelha, faríamos algo assim:</p>

<pre class="mac_classic"><span class="LibraryObject">User</span>.<span class="FunctionName">all</span> <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>joins</span> =&gt; <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>items</span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>conditions</span> =&gt; [<span class="String"><span class="String">&quot;</span>items.color = ?<span class="String">&quot;</span></span>, <span class="String"><span class="String">'</span>red<span class="String">'</span></span>]
</pre>

<p>Este tipo de sintaxe parece incomodar já que você precisa incluir o nome da tabela (no caso <strong>items</strong>) dentro de uma <strong>string</strong>. O código parece estranho.</p>

<p>No Rails 2.2 encontraremos uma novidade nesta questão, nos permitindo fazer a mesma coisa de uma forma um pouco diferente, usando uma chave dentro do <strong>hash</strong> para identificar a tabela:</p>

<pre class="mac_classic"><span class="LibraryObject">User</span>.<span class="FunctionName">all</span> <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>joins</span> =&gt; <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>items</span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>conditions</span> =&gt; {
  <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>age</span> =&gt; <span class="Number">10</span>,
  <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>items</span> =&gt; { <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>color</span> =&gt; <span class="String"><span class="String">'</span>red<span class="String">'</span></span> }
}

<span class="Comment"><span class="Comment">#</span> um outro exemplo que talvez deixe o código mais claro</span>
<span class="LibraryObject">User</span>.<span class="FunctionName">all</span> <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>joins</span> =&gt; <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>items</span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>conditions</span> =&gt; {
  <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>users</span> =&gt; { <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>age</span> =&gt; <span class="Number">10</span> },
  <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>items</span> =&gt; { <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>color</span> =&gt; <span class="String"><span class="String">'</span>red<span class="String">'</span></span> }
}
</pre>

<p>Na minha opinião, desta forma o código fica muito mais claro, principalmente se temos de condicionar muitos campos de várias tabelas diferentes.</p>

<p>Só tenha em mente que a chave usada é o nome da tabela (você percebe pelo nome pluralizado) ou um alias caso você o tenha especificado na query.</p>

<h2> Nova opção :from para métodos de cálculo do ActiveRecord</h2>

<p>Uma nova opção foi incluída aos métodos de cálculos do <strong>ActiveRecord</strong> (<strong>count</strong>, <strong>sum</strong>, <strong>average</strong>, <strong>minimum</strong> e <strong>maximum</strong>).</p>

<p>Ao fazer uso da opção <strong>:from</strong>, podemos sobrecarregar o nome da tabela na query gerada pelo <strong>ActiveRecord</strong>, o que não parece muito útil em um primeiro momento. Mas algo interessante que esta opção nos permite fazer é forçar o MySQL a usar um índice especifico ao realizar o cálculo desejado.</p>

<p>Veja alguns exemplos de uso:</p>

<pre class="mac_classic"><span class="Comment"><span class="Comment">#</span> Forçando o MySQL a usar um índice para realizar o cálculo</span>
<span class="LibraryObject">Edge</span>.<span class="FunctionName">count</span> <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>all</span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>from</span> =&gt; <span class="String"><span class="String">'</span>edges USE INDEX(unique_edge_index)<span class="String">'</span></span>,
           <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>conditions</span> =&gt; <span class="String"><span class="String">'</span>sink_id &lt; 5<span class="String">'</span></span>)

<span class="Comment"><span class="Comment">#</span> Realizando o cálculo em uma tabela diferente da associada a classe</span>
<span class="LibraryObject">Company</span>.<span class="FunctionName">count</span> <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>all</span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>from</span> =&gt; <span class="String"><span class="String">'</span>accounts<span class="String">'</span></span>
</pre>

<h2> Definindo como o método validates_length_of deve funcionar</h2>

<p>O método <strong>validates_length_of</strong> faz parte dos muitos métodos de validação contidos no <strong>ActiveRecord</strong>. Este método em particular serve para garantir que o valor gravado em uma determinada coluna no banco de dados terá um tamanho máximo, mínimo, exato, ou até mesmo se está em um intervalo de valores.</p>

<p>Mas o termo "tamanho" é relativo. Hoje quando dizemos "tamanho" estamos nos referindo a quantidade de caracteres no texto.</p>

<p>Mas imagine um caso onde eu tenha um campo em um formulário onde a limitação não seja definida pela quantidade de caracteres e sim pela quantidade de palavras, algo como "escreva um texto com no mínimo 100 palavras". Imagine uma página onde o usuário tenha de redigir uma redação, por exemplo.</p>

<p>Hoje, para validar isto não teríamos outra escolha senão criarmos um novo método que faça esta validação. Mas à partir do Rails 2.2 poderemos personalizar o método <strong>validates_length_of</strong> para funcionar da forma como desejamos usando a opção <strong>:tokenizer</strong>.</p>

<p>Veja um exemplo que resolveria o problema citado acima:</p>

<pre class="mac_classic">validates_length_of <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>essay</span>,
                    <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>minimum</span> =&gt; <span class="Number">100</span>,
                    <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>too_short</span> =&gt; <span class="String"><span class="String">&quot;</span>Sua redação deve ter no mínimo %d palavras.<span class="String">&quot;</span></span>),
                    <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>tokenizer</span> =&gt; lambda {|<span class="Variable">str</span>| str.<span class="FunctionName">scan</span>(<span class="String"><span class="String">/</span></span><span class="String"><span class="StringInterpolation">\w</span>+</span><span class="String"><span class="String">/</span></span>) }
</pre>

<p>Este é apenas um exemplo do que podemos fazer com esta nova opção. Além disso podemos usa-lá para contar apenas a quantidade de dígitos, menções de uma única palavra, etc..</p>

<h1> ActiveSupport</h1>

<p>Active Support é uma coleção de várias classes úteis e extensões de bibliotecas padrões, que foram considerados úteis para aplicações em Ruby on Rails.
(wikipedia)</p>

<h2> Array#second até Array#tenth</h2>

<p>No objeto Array já tínhamos o método <strong>first</strong> e <strong>last</strong>, então porque não ter também os métodos <strong>second</strong>, <strong>third</strong>, <strong>fourth</strong> e assim por diante? É isso mesmo, foram acrescentados ao objeto <strong>Array</strong> os métodos que vão do <strong>second</strong> (segundo) até o <strong>tenth</strong> (décimo), que servem para retornar o objeto especifico dentro do <strong>Array</strong> (o terceiro objeto do array, por exemplo).</p>

<p>Vamos aos exemplos:</p>

<pre class="mac_classic">array <span class="Keyword">=</span> (<span class="Number">1</span>..<span class="Number">10</span>).<span class="FunctionName">to_a</span>

array.<span class="FunctionName">second</span>  <span class="Comment"><span class="Comment">#</span> =&gt; array[1]</span>
array.<span class="FunctionName">third</span>   <span class="Comment"><span class="Comment">#</span> =&gt; array[2]</span>
array.<span class="FunctionName">fourth</span>  <span class="Comment"><span class="Comment">#</span> =&gt; array[3]</span>
array.<span class="FunctionName">fifth</span>   <span class="Comment"><span class="Comment">#</span> =&gt; array[4]</span>
array.<span class="FunctionName">sixth</span>   <span class="Comment"><span class="Comment">#</span> =&gt; array[5]</span>
array.<span class="FunctionName">seventh</span> <span class="Comment"><span class="Comment">#</span> =&gt; array[6]</span>
array.<span class="FunctionName">eighth</span>  <span class="Comment"><span class="Comment">#</span> =&gt; array[7]</span>
array.<span class="FunctionName">ninth</span>   <span class="Comment"><span class="Comment">#</span> =&gt; array[8]</span>
array.<span class="FunctionName">tenth</span>   <span class="Comment"><span class="Comment">#</span> =&gt; array[9]</span>
</pre>

<h2> Crie regras para o String#humanize</h2>

<p>Já faz um certo tempo que Pratik Naik estava tentando colocar este patch no Rails e parece que finalmente conseguiu.</p>

<p>No arquivo <strong>config/initializers/inflections.rb</strong> você tem a opção de acrescentar novas inflexões para pluralização, singularização e outros:</p>

<pre class="mac_classic"><span class="LibraryObject">Inflector</span>.<span class="FunctionName">inflections</span> <span class="Keyword">do </span>|<span class="Variable">inflect</span>|
  inflect.<span class="FunctionName">plural</span> <span class="Keyword">/</span><span class="Keyword">^</span>(ox)<span class="Variable"><span class="Variable">$</span>/</span>i, <span class="String"><span class="String">'</span>en<span class="String">'</span></span>
  inflect.<span class="FunctionName">singular</span> <span class="Keyword">/</span><span class="Keyword">^</span>(ox)en<span class="Keyword">/</span>i, <span class="String"><span class="String">'</span><span class="String">'</span></span>
  inflect.<span class="FunctionName">irregular</span> <span class="String"><span class="String">'</span>person<span class="String">'</span></span>, <span class="String"><span class="String">'</span>people<span class="String">'</span></span>
  inflect.<span class="FunctionName">uncountable</span> <span class="String"><span class="String">%w(</span> fish sheep <span class="String">)</span></span>
<span class="Keyword">end</span>
</pre>

<p>No Rails 2.2 você também pode incluir inflexões para o método <strong>humanize</strong> da classe <strong>String</strong>. Vamos aos famosos exemplos:</p>

<pre class="mac_classic"><span class="String"><span class="String">'</span>jargon_cnt<span class="String">'</span></span>.<span class="FunctionName">humanize</span> <span class="Comment"><span class="Comment">#</span> =&gt; &quot;Jargon cnt&quot;</span>
<span class="String"><span class="String">'</span>nomedojogo<span class="String">'</span></span>.<span class="FunctionName">humanize</span> <span class="Comment"><span class="Comment">#</span> =&gt; &quot;Nomedojogo&quot;</span>

<span class="LibraryObject">ActiveSupport</span>::<span class="FunctionName">Inflector</span>.<span class="FunctionName">inflections</span> <span class="Keyword">do </span>|<span class="Variable">inflect</span>|
  inflect.<span class="FunctionName">human</span>(<span class="String"><span class="String">/</span></span><span class="String">_cnt$</span><span class="String"><span class="String">/i</span></span>, <span class="String"><span class="String">'</span>_count<span class="String">'</span></span>)
  inflect.<span class="FunctionName">human</span>(<span class="String"><span class="String">'</span>nomedojogo<span class="String">'</span></span>, <span class="String"><span class="String">'</span>Nome do Jogo<span class="String">'</span></span>)
<span class="Keyword">end</span>

<span class="String"><span class="String">'</span>jargon_cnt<span class="String">'</span></span>.<span class="FunctionName">humanize</span> <span class="Comment"><span class="Comment">#</span> =&gt; &quot;Jargon count&quot;</span>
<span class="String"><span class="String">'</span>nomedojogo<span class="String">'</span></span>.<span class="FunctionName">humanize</span> <span class="Comment"><span class="Comment">#</span> =&gt; &quot;Nome do jogo&quot;</span>
</pre>

<h2> Introduzindo Memoizable para cache de atributos</h2>

<p>Performance é coisa séria, e um dos métodos mais usados para aumentar a velocidade de execução em códigos é o uso de cache. Quem nunca fez algo assim?</p>

<pre class="mac_classic"><span class="Keyword">class</span> <span class="TypeName">Person<span class="InheritedClassName"> <span class="InheritedClassName">&lt;</span> ActiveRecord::Base</span></span>
  <span class="Keyword">def</span> <span class="FunctionName">age</span>
    <span class="Variable"><span class="Variable">@</span>age</span> <span class="Keyword">||=</span> um_calculo_muito_complexo
  <span class="Keyword">end</span>
<span class="Keyword">end</span>
</pre>

<p>Nesta versão do Rails temos uma forma mais elegante de fazer isto usando o método <strong>memoize</strong> (é <strong>memoize</strong> mesmo e não <strong>memorize</strong>). Vamos alterar o exemplo acima para funcionar com esta nova funcionalidade:</p>

<pre class="mac_classic"><span class="Keyword">class</span> <span class="TypeName">Person<span class="InheritedClassName"> <span class="InheritedClassName">&lt;</span> ActiveRecord::Base</span></span>
  <span class="Keyword">def</span> <span class="FunctionName">age</span>
    um_calculo_muito_complexo
  <span class="Keyword">end</span>
  memoize <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>age</span>
<span class="Keyword">end</span>
</pre>

<p>O método <strong>age</strong> será executado apenas uma vez e o seu retorno será armazenado e retornado em futuras chamadas ao método.</p>

<p>Só existe uma diferença entre os dois códigos acima. No primeiro, como o método é executado todas as vezes, se o valor armazenado na variável <strong>@age</strong> for <strong>nil</strong> ou <strong>false</strong> o cálculo (muito complexo) será executado novamente até termos a idade da pessoa.</p>

<p>No segundo exemplo, o método <strong>age</strong> só será executado uma vez e o valor retornado será sempre devolvido nas próximas chamadas, mesmo que seja <strong>nil</strong> ou <strong>false</strong>.</p>

<h1> ActiveResource</h1>

<p>O ActiveResource é uma camada de mapeamento responsável pela implementação do lado cliente de sistemas RESTful. Através do ActiveResource é possível consumir serviços RESTful através do uso de objetos que funcionam como um proxy para serviços remotos.</p>

<h1> ActionPack</h1>

<p>Compreende o Action View (geração de visualização de usuário, como HTML, XML, JavaScript, entre outros) e o Action Controller (controle de fluxo de negócio).
(wikipedia)</p>

<h2> Nova opção :layout no método caches_action</h2>

<p>Foi acrescentado a opção <strong>:layout</strong> no método <strong>caches_action</strong>.</p>

<pre class="mac_classic"><span class="Keyword">class</span> <span class="TypeName">ListsController<span class="InheritedClassName"> <span class="InheritedClassName">&lt;</span> ApplicationController</span></span>
  ...

  caches_action <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>index</span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>layout</span> =&gt; <span class="BuiltInConstant">false</span>

  ...
<span class="Keyword">end</span>
</pre>

<p>No exemplo acima eu especifiquei <strong>:layout => false</strong>, isto significa que o layout não será armazenado no cache, apenas o conteúdo da action será. Isto é muito útil quando temos conteúdo dinâmico no layout (o que acontece na maioria dos casos).</p>

<p>Se você não especificar nada ele assumirá o padrão atual que é <strong>true</strong>.</p>

<h2> RJS#page.reload</h2>

<p>O método <strong>reload</strong> foi incluído ao <strong>ActionView::Helpers::PrototypeHelper</strong> para ser usado em templates <strong>.rjs</strong> ou blocos <strong>render(:update)</strong>. Este método força a recarga da página atual no browser usando javascript. Em outras palavras é um atalho para o já muito usado <strong>window.location.reload();</strong>.</p>

<p>Veja como usar:</p>

<pre class="mac_classic">respond_to <span class="Keyword">do </span>|<span class="Variable">format</span>|
  format.<span class="FunctionName">js</span> <span class="Keyword">do</span>
    <span class="FunctionName">render</span>(<span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>update</span>) { |<span class="Variable">page</span>| page.<span class="FunctionName">reload</span> }
  <span class="Keyword">end</span>
<span class="Keyword">end</span>
</pre>

<h2> Dando um nome para a variável local de uma coleção de partials</h2>

<p>No código abaixo estamos usando uma <strong>partial</strong> com uma coleção de dados:</p>

<pre class="mac_classic">render <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>partial</span> =&gt; <span class="String"><span class="String">&quot;</span>admin_person<span class="String">&quot;</span></span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>collection</span> =&gt; <span class="Variable"><span class="Variable">@</span>winners</span>
</pre>

<p>Dentro da <strong>partial</strong> podemos usar então a variável <strong>admin_person</strong> para acessar os itens da coleção. Mas temos de concordar que este nome de variável é meio ruim.</p>

<p>Agora temos a opção de personalizar o nome desta variável usando a opção <strong>:as</strong>. Vamos alterar o exemplo acima:</p>

<pre class="mac_classic">render <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>partial</span> =&gt; <span class="String"><span class="String">&quot;</span>admin_person<span class="String">&quot;</span></span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>collection</span> =&gt; <span class="Variable"><span class="Variable">@</span>winners</span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>as</span> =&gt; <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>person</span>
</pre>

<p>Agora podemos acessar cada item da coleção usando a variável <strong>person</strong> que tem um nome mais intuitivo.</p>

<h2> polymorphic_url agora é capaz de lidar com recursos singleton</h2>

<p>Para mais detalhes sobre o que são rotas singulares veja o capítulo "Informações Adicionais" no fim deste livro.</p>

<p>Até agora o helper <strong>polymorphic_url</strong> não estava tratando singleton resources corretamente.</p>

<p>Um novo patch foi incluído no Rails para permitir que especifiquemos um singular resource usando símbolos, assim como fazemos com namespaces. Exemplo:</p>

<pre class="mac_classic"><span class="Comment"><span class="Comment">#</span> este código</span>
<span class="FunctionName">polymorphic_url</span>([<span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>admin</span>, <span class="Variable"><span class="Variable">@</span>user</span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>blog</span>, <span class="Variable"><span class="Variable">@</span>post</span>])

<span class="Comment"><span class="Comment">#</span> é a mesma coisa que</span>
<span class="FunctionName">admin_user_blog_post_url</span>(<span class="Variable"><span class="Variable">@</span>user</span>, <span class="Variable"><span class="Variable">@</span>post</span>)
</pre>

<h1> ActionController</h1>

<p>O ActionController é a camada responsável por receber as requisições web e de tomar as decisões do quê será executado e renderizado ou de redirecionar para outra ação.
Uma ação é definido como métodos públicos nos controladores que são automaticamente disponíveis através das rotas.</p>

<h1>ActionView</h1>

<p>O ActionView é a camada responsável pela geração da interface visível ao usuário através da conversão dos templates ERB.</p>

<h1> Railties</h1>

<h2> Suporte ao Thin melhorado no Rails</h2>

<p>O <strong>script/server</strong> agora verifica a disponibilidade do <strong>Thin</strong> e o usa. Muito conveniente se vocês estiver usando <strong>Thin</strong> no seu ambiente de produção (e quiser rodar o mesmo em desenvolvimento). Você deve acrescentar a seguinte linha no seu arquivo <strong>environment.rb</strong> para que isto funcione.</p>

<pre class="mac_classic">config.<span class="FunctionName">gem</span> <span class="String"><span class="String">'</span>thin<span class="String">'</span></span>
</pre>

<h1> Rake Tasks, Plugins e Scripts</h1>

<h1> Prototype e script.aculo.us</h1>

<h1> Ruby 1.9</h1>

<h1> Performace</h1>

<h2> Melhorando a performace do Rails</h2>

<p>Jeremy Kemper andou trabalhando em melhorias de performace no Rails.Uma das coisas que ele andou melhorando foi o <strong>Erb</strong>, tornando-o mais rápido. Além disso ele tem atacado alguns métodos especiais como o <strong>concat</strong> e <strong>capture</strong> que são usados por muitos <strong>helpers</strong> do Rails.</p>

<p>Jeremy também atacou o processo de inicialização de <strong>partials</strong> e otimizou diversos helpers que geravam código em <strong>Javascript</strong>.</p>

<p>A classe <strong>RecordIdentifier</strong> também foi melhorada através do uso de caches. O <strong>RecordIdentifier</strong> incorpora uma série de convenções para lidar com registros <strong>ActiveRecords</strong> e <strong>ActiveResources</strong> ou praticamente qualquer outro tipo de modelo que tenha um id.</p>

<p>É interessante ver este tipo de ação, o Rails já está ficando grande e pesado demais, e processos de otimização devem se tornar uma contante daqui para frente.</p>

<h2> Criando testes de performace</h2>

<p>No Rails 2.2 ganhamos um novo <strong>generator</strong> para testes de performace.</p>

<p>Ao executar no terminal o seguinte comando:</p>

<pre class="mac_classic">[carlosbrando<span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>edge</span>]$ .<span class="Keyword">/</span>script<span class="Keyword">/</span>generate performance_test <span class="Variable">Login</span>
      exists  test<span class="Keyword">/</span>performance<span class="Keyword">/</span>
      create  test<span class="Keyword">/</span>performance<span class="Keyword">/</span>login_test.<span class="FunctionName">rb</span>
</pre>

<p>Será criado um arquivo chamado <strong>test/performance/login_test.rb</strong>. Veja o código gerado:</p>

<pre class="mac_classic"><span class="Keyword">require</span> <span class="String"><span class="String">'</span>performance/test_helper<span class="String">'</span></span>

<span class="Keyword">class</span> <span class="TypeName">LoginTest<span class="InheritedClassName"> <span class="InheritedClassName">&lt;</span> ActionController::PerformanceTest</span></span>
<span class="Comment">  <span class="Comment">#</span> Replace this with your real tests.</span>
  <span class="Keyword">def</span> <span class="FunctionName">test_homepage</span>
    get <span class="String"><span class="String">'</span>/<span class="String">'</span></span>
  <span class="Keyword">end</span>
<span class="Keyword">end</span>
</pre>

<p>Neste arquivo podemos colocar todos os testes que desejarmos e ao executá-lo teremos informações sobre cada um dos testes, como tempo de processamento, uso de memória e outros. Para realizar o teste executamos no terminal:</p>

<pre class="mac_classic">[carlosbrando<span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>edge</span>]$ ruby test<span class="Keyword">/</span>performance<span class="Keyword">/</span>login_test.<span class="FunctionName">rb</span>
<span class="Variable">Loaded</span> suite test<span class="Keyword">/</span>performance<span class="Keyword">/</span>login_test
<span class="Variable">Started</span>
<span class="Variable">LoginTest</span><span class="Comment"><span class="Comment">#</span>test_homepage (32 ms warmup)</span>
        process_time: <span class="Number">11</span> ms
              memory: unsupported
             objects: unsupported
.
<span class="Variable">Finished</span> <span class="Keyword">in</span> <span class="Number">0.870842</span> seconds.
</pre>

<h1> Bugs e Correções</h1>

<h2> Correção nas tarefas db:migrate:down e :up</h2>

<p>Quando se usava o comando <strong>rake db:migrate:down VERSION=alguma_versão</strong>, os registros na tabela <strong>schema_migrations</strong> não eram atualizados.</p>

<p>Isto significa que após usar o comando <strong>rake db:migrate:down</strong> ou <strong>up</strong> se você rodar o comando <strong>rake db:migrate</strong> algumas <strong>migrations</strong> podem não ser executadas. Vamos simular isto para ficar fácil de entender o problema:</p>

<pre class="mac_classic">$ .<span class="Keyword">/</span>script<span class="Keyword">/</span>generate migration test_migration
      create  db<span class="Keyword">/</span>migrate
      create  db<span class="Keyword">/</span>migrate<span class="Keyword">/</span>20080608082216_test_migration.<span class="FunctionName">rb</span>

$ rake db<span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>migrate</span>
(<span class="Keyword">in</span> <span class="Keyword">/</span><span class="Variable">Users</span><span class="Keyword">/</span>erik<span class="Keyword">/</span>projects<span class="Keyword">/</span>railstest)
<span class="Keyword">==</span> <span class="Number">20080608082216</span> <span class="Variable">TestMigration</span>: migrating <span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span>
<span class="Keyword">-</span><span class="Keyword">-</span> <span class="FunctionName">create_table</span>(<span class="String"><span class="String">&quot;</span>foo<span class="String">&quot;</span></span>)
   <span class="Keyword">-</span><span class="Keyword">&gt;</span> <span class="Number">0.</span>0137s
<span class="Keyword">==</span> <span class="Number">20080608082216</span> <span class="Variable">TestMigration</span>: migrated (<span class="Number">0.</span>0140s) <span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span>

$ rake db<span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>migrate</span><span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>down</span> <span class="Variable">VERSION</span><span class="Keyword">=</span><span class="Number">20080608082216</span>
(<span class="Keyword">in</span> <span class="Keyword">/</span><span class="Variable">Users</span><span class="Keyword">/</span>erik<span class="Keyword">/</span>projects<span class="Keyword">/</span>railstest)
<span class="Keyword">==</span> <span class="Number">20080608082216</span> <span class="Variable">TestMigration</span>: reverting <span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span>
<span class="Keyword">-</span><span class="Keyword">-</span> <span class="FunctionName">drop_table</span>(<span class="String"><span class="String">&quot;</span>foo<span class="String">&quot;</span></span>)
   <span class="Keyword">-</span><span class="Keyword">&gt;</span> <span class="Number">0.</span>0139s
<span class="Keyword">==</span> <span class="Number">20080608082216</span> <span class="Variable">TestMigration</span>: reverted (<span class="Number">0.</span>0144s) <span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span><span class="Keyword">===</span>

$ rake db<span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>migrate</span>
(<span class="Keyword">in</span> <span class="Keyword">/</span><span class="Variable">Users</span><span class="Keyword">/</span>erik<span class="Keyword">/</span>projects<span class="Keyword">/</span>railstest)

$
</pre>

<p>Este problema foi corrigido ao se certificar de atualizar a tabela <strong>schema_migrations</strong> após a execução destas tarefas.</p>

<h2> end_of_quarter</h2>

<p>Nem bem havia saído o Rails 2.1 e já foi encontrado um erro sério. Se você ainda tiver um projeto criado nesta versão entre no <strong>irb</strong> e tente rodar isto:</p>

<pre class="mac_classic"><span class="LibraryObject">Date</span>.<span class="FunctionName">new</span>(<span class="Number">2008</span>, <span class="Number">5</span>, <span class="Number">31</span>).<span class="FunctionName">end_of_quarter</span>
</pre>

<p><strong>ERRO!</strong></p>

<p>Por que? A implementação do método <strong>end_of_quarter</strong> foi feita da maneira errada, ele avança até o último mês do trimestre e depois pega último dia. O problema é que ele apenas avança o mês, e como estou partindo do dia 31 de maio, ele tentar criar uma nova instância do objeto <strong>Date</strong> para 31 de junho, que não existe. Com o objeto <strong>Time</strong> não é disparado uma exceção, mas ele retorna a data errada: 31 de julho.</p>

<p>Nesta versão este erro já foi corrigido, mas caso você ainda esteja usando a versão 2.1 em algum projeto, muito cuidado, porque este erro só ocorrerá se usarmos o método <strong>end_of_quarter</strong> nos dias 31 de maio, julho e agosto.</p>

<h2> PostgreSQL</h2>

<p>No PostgreSQL, a sintaxe dele de <strong>typecast</strong> é a seguinte: <column>::<type></p>

<p>O problema é que quando se usava essa sintaxe, o <strong>ActiveRecord</strong> achava que o na verdade era um named bind e reclamava que o valor para ele não estava sendo passado no <strong>hash</strong>. Agora este problema está corrigido, permitindo que façamos algo assim:</p>

<pre class="mac_classic"><span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>conditions</span> =&gt; [<span class="String"><span class="String">'</span>:foo::integer<span class="String">'</span></span>, { <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>foo</span> =&gt; <span class="Number">1</span> }]
</pre>

<h2> Solução de bug no método rename_column</h2>

<p>Esta alteração trata-se na verdade de uma correção de um bug no método <strong>rename_column</strong>. Para entender qual era o problema precisamos de um cenário como exemplo. Primeiro criamos um <strong>migration</strong>:</p>

<pre class="mac_classic">create_table <span class="String"><span class="String">&quot;</span>users<span class="String">&quot;</span></span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>force</span> =&gt; <span class="BuiltInConstant">true</span> <span class="Keyword">do </span>|<span class="Variable">t</span>|
  t.<span class="FunctionName">column</span> <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>name</span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>string</span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>default</span> =&gt; <span class="String"><span class="String">'</span><span class="String">'</span></span>
<span class="Keyword">end</span>
</pre>

<p>Ok, agora criamos um segundo <strong>migration</strong> onde vamos renomear a coluna <strong>name</strong> da tabela:</p>

<pre class="mac_classic">rename_column <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>users</span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>name</span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>first_name</span>
</pre>

<p>Se você fizer o teste em sua máquina, notará que ao usar o método <strong>rename_column</strong> a "nova" coluna <strong>first_name</strong> não terá mais o valor padrão definido no primeiro <strong>migration</strong>.</p>

<p>Este bug já está resolvido para esta versão do Rails.</p>

<h1> Informações Adicionais</h1>

<h2> O que é uma Rota Singular?</h2>

<p>Além do <strong>map.resources</strong>, há também uma forma singular (ou "singleton") de rotear recursos: <strong>map.resource</strong>. Esta forma é usada para representar um recurso que só aparece uma vez no contexto.</p>

<p>Faz muito sentido usar uma rota singular quando temos um recurso que será único dentro da aplicação ou da sessão do usuário corrente.</p>

<p>Por exemplo, em um projeto de uma agenda cada usuário registrado tem seu próprio catálogo de endereços, então poderíamos cria nossa rota assim:</p>

<pre class="mac_classic">map.<span class="FunctionName">resource</span> <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>address_book</span>
</pre>

<p>Com isto podemos usar todo o conjunto de recursos disponibilizados pelo Rails, tais como:</p>

<pre class="mac_classic"><span class="Variable">GET</span><span class="Keyword">/</span><span class="Variable">PUT</span> address_book_url
<span class="Variable">GET</span>     edit_address_book_url
<span class="Variable">PUT</span>     update_address_book_url
</pre>

<p>Note que tudo está no singular. Estamos assumindo que no contexto atual não precisamos especificar qual catálogo de endereços desejamos, ao invés disso podemos simplesmente dizer "o catálogo de endereços", já que o usuário atual só tem um.</p>

<p>O relacionamento entre a tabela de catálogos e o usuário corrente não é automático, você deve autenticar o usuário e retornar o catálogo dele. Não existe mágica aqui, é apenas uma outra técnica de roteamento a nossa disposição, se precisarmos.</p>

<h1> CHANGELOG</h1>

	</div>

	<div class="white_page"></div>
	<div class="white_page"></div>
	
	<div class="backcover"></div>
</body>
</html>
