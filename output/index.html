<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	"http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<link rel="stylesheet" type="text/css" href="../layout/second.css"/>
	<link rel="stylesheet" type="text/css" href="../layout/mac_classic.css"/>
</head>
<body>
	<div class="frontcover"></div>

	<div class="halftitlepage">
		<h1 class="no-toc">Ruby on Rails 2.1</h1>
		<h2 class="no-toc">What's New</h2>
		<h3 class="no-toc">Second Edition</h3>
	</div>

	<div class="titlepage">
	<h1 class="no-toc">Ruby on Rails 2.1</h1>

	<h2 class="no-toc">What's New</h2>
	<h3 class="no-toc">Second Edition</h3>

	<p class="no-toc">Carlos Brando<br/>Marcos Tapajós</p>
	<!-- also, the publisher's name would typically be printed here -->
	</div>
	
	<div class="imprint">
		<p>&copy; Copyright 2008 Carlos Brando. All Rights Reserved.</p>
		<br/>
		<p>Second edition: June 2008</p>
		<br/>
		<p>Carlos Brando<br/>Website: www.nomedojogo.com</p>
		<p>Marcos Tapajós<br/>Website: www.improveit.com.br/en/company/tapajos</p>
	</div>
	
	<!-- <div class="toc">
		<h1>Sumário</h1>
		#toc
	</div> -->
	
	<div class="chapter">
		<h1>Introduction</h1>

<p>Around July of 2004 David Heinemeier Hansson publicly released the Ruby on Rails framework. The framework had been extracted from a web application called he was working on called Basecamp. More than three years later, on the December 7th 2007, Ruby on Rails version 2.0 was released with numerous important changes.</p>

<p>Six months have passed since then, and during this time more than <strong>1400 developers</strong> from all around the world have contributed  <strong>1600 patches</strong> to the framework. Today, June 1st 2008, version 2.1 of the Ruby on Rails framework was released.</p>

<p>Major new features according to David Heinemeier Hansson:</p>

<ul>
<li>Timezones</li>
<li>Dirty tracking</li>
<li>Gem Dependencies</li>
<li>Named scope</li>
<li>UTC-based migrations</li>
<li>Better caching</li>
</ul>


<p>As always, to update or install the new version:</p>

<pre class="mac_classic">gem install rails
</pre>

<h2>Acknowledgment</h2>

<p>To Marcos Tapajós, co-author of this book. If it wasn't for him, you probably you wouldn't be reading this right now.</p>

<p>To Daniel Lopes who made the beautiful cover for this edition.</p>

<p>To all of the Ruby on Rails Brazilian community that helped directly or indirectly with this book, commenting on blog posts and giving suggestions. It's like I always say, the best of Rails is its community! Keep creating, inventing, and specially sharing.</p>

<h2> Translators</h2>

<p>This book was proudly translated to english by these Brazilian guys:</p>

<p><strong>Pedro Pimentel</strong> - <a href="http://www.pedropimentel.com">http://www.pedropimentel.com</a></p>

<p>Chapters 3-8 and 10-13</p>

<p><strong>Rafael Barbosa</strong> - <a href="http://www.act-as-newbie.com/">http://www.act-as-newbie.com</a></p>

<p>Introduction and chapter 1</p>

<p><strong>Ricardo S Yasuda</strong> - <a href="http://blog.shadowmaru.org/">http://blog.shadowmaru.org</a></p>

<p>Chapter 14</p>

<p><strong>Caike Souza</strong> - <a href="http://tech-death.blogspot.com/">http://tech-death.blogspot.com</a></p>

<p>Chapter 2</p>

<p><strong>Abraão Coelho</strong> - <a href="http://abrcoelho.net/">http://abrcoelho.net</a></p>

<p>Chapter 9</p>

<p><strong>Bruno Miranda</strong> - <a href="http://brunomiranda.com">http://brunomiranda.com</a></p>

<p>Reviser</p>

<h1> ActiveRecord</h1>

<h1> THIS SOUNDS WEIRD</h1>

<p>ActiveRecord is an object-relational mapping layer that is responsible for  interoperability between the application and the database and for abstracting data.</p>

<h1> O Active Record é uma camada de mapeamento objeto-relacional (object-relational mapping layer), responsável pela interoperabilidade entre a aplicação e o banco de dados e pela abstração dos dados.</h1>

<h1> (wikipedia)</h1>

<h2> New options for assocations: :validate</h2>

<p>A new option for associations has been added to Rails. If you include the <strong>:validate => false</strong> option on an association, <strong>ActiveRecord</strong> will save the data of the parent object without validating the associated objects.  For example:</p>

<pre class="mac_classic"><span class="Keyword">class</span> <span class="TypeName">AuditLog<span class="InheritedClassName"> <span class="InheritedClassName">&lt;</span> ActiveRecord::Base</span></span>
  belongs_to <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>developer</span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>validate</span> =&gt; <span class="BuiltInConstant">false</span>
<span class="Keyword">end</span>

log <span class="Keyword">=</span> <span class="LibraryObject">AuditLog</span>.<span class="FunctionName">create</span>(<span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>developer_id</span> =&gt; <span class="Number">0</span> , <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>message</span> =&gt; <span class="String"><span class="String">&quot;</span><span class="String">&quot;</span></span>)
log.<span class="FunctionName">developer</span> <span class="Keyword">=</span> <span class="LibraryObject">Developer</span>.<span class="FunctionName">new</span>

puts log.<span class="FunctionName">developer</span>.<span class="FunctionName">valid?</span>
<span class="Comment"><span class="Comment">#</span> =&gt; false</span>

puts log.<span class="FunctionName">valid?</span>
<span class="Comment"><span class="Comment">#</span> =&gt; true</span>

puts log.<span class="FunctionName">save</span>
<span class="Comment"><span class="Comment">#</span> =&gt; true</span>
</pre>

<p>Note that even though the association is not valid, the object <strong>log</strong> gets saved.</p>

<p>The default value is <strong>false</strong>, that is, all validations in <strong>belongs_to</strong> associations will be disconnected by default and if you want to connect them you need to use <strong>:validate => true</strong>.</p>

<h2> A new way of specifying conditions with a Hash</h2>

<p>When performing database queries, sometimes you need to use the <strong>:joins</strong> option, either to improve application performance or when you need to retrieve information that depends on results from more than one table.</p>

<p>For example, if you wanted to retrieve all users who bought red items, you could do something like this:</p>

<pre class="mac_classic"><span class="LibraryObject">User</span>.<span class="FunctionName">all</span> <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>joins</span> =&gt; <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>items</span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>conditions</span> =&gt; [<span class="String"><span class="String">&quot;</span>items.color = ?<span class="String">&quot;</span></span>, <span class="String"><span class="String">'</span>red<span class="String">'</span></span>]
</pre>

<p>This syntax is a little painful, since you need to include the name of the table (<strong>items</strong> in this case) inside a <strong>string</strong>. The code seems weird.</p>

<p>In Rails 2.2 there is a new way of doing this, using a hash key to identify the table:</p>

<pre class="mac_classic"><span class="LibraryObject">User</span>.<span class="FunctionName">all</span> <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>joins</span> =&gt; <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>items</span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>conditions</span> =&gt; {
  <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>age</span> =&gt; <span class="Number">10</span>,
  <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>items</span> =&gt; { <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>color</span> =&gt; <span class="String"><span class="String">'</span>red<span class="String">'</span></span> }
}

<span class="Comment"><span class="Comment">#</span> another example that perhaps makes the code a little clearer</span>
<span class="LibraryObject">User</span>.<span class="FunctionName">all</span> <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>joins</span> =&gt; <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>items</span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>conditions</span> =&gt; {
  <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>users</span> =&gt; { <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>age</span> =&gt; <span class="Number">10</span> },
  <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>items</span> =&gt; { <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>color</span> =&gt; <span class="String"><span class="String">'</span>red<span class="String">'</span></span> }
}
</pre>

<p>In my opinion, the code is a lot clearer this way, especially when you need to provide conditions for many fields from various tables.</p>

<p>Just keep in mind that the key you use is the (plural) name of the table or an alias, if you have specified one in the query.</p>

<h2> New :from option for calculation methods in ActiveRecord</h2>

<p>A new option has been included in the calculation methods of <strong>ActiveRecord</strong> (<strong>count</strong>, <strong>sum</strong>, <strong>average</strong>, <strong>minimum</strong> and <strong>maximum</strong>).</p>

<p>When you use the <strong>:from</strong> option, you can override the name of the table in the query that <strong>ActiveRecord</strong> generates, which doesn't seem very useful at first glance, but one interesting thing that this allows you to do is force MySQL to use a specific index for the calculation.</p>

<p>Check out some examples:</p>

<pre class="mac_classic"><span class="Comment"><span class="Comment">#</span> Forcing MySQL to use an index for a calculation</span>
<span class="LibraryObject">Edge</span>.<span class="FunctionName">count</span> <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>all</span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>from</span> =&gt; <span class="String"><span class="String">'</span>edges USE INDEX(unique_edge_index)<span class="String">'</span></span>,
           <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>conditions</span> =&gt; <span class="String"><span class="String">'</span>sink_id &lt; 5<span class="String">'</span></span>)

<span class="Comment"><span class="Comment">#</span> Doing the calculation in a different table from the associated class</span>
<span class="LibraryObject">Company</span>.<span class="FunctionName">count</span> <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>all</span>, <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>from</span> =&gt; <span class="String"><span class="String">'</span>accounts<span class="String">'</span></span>
</pre>

<h2> The merge_conditions method in ActiveRecord is now public</h2>

<p>The <strong>merge_conditions</strong> method in <strong>ActiveRecord</strong> is now a public method, which means that it will be available in all your <strong>Models</strong>.</p>

<p>This method does exactly what its name says&mdash;it allows you provide many different <strong>conditions</strong> in your parameters that get combined into a single condition. Por exemplo:</p>

<pre class="mac_classic"><span class="Keyword">class</span> <span class="TypeName">Post<span class="InheritedClassName"> <span class="InheritedClassName">&lt;</span> ActiveRecord::Base</span></span>
<span class="Keyword">end</span>

a <span class="Keyword">=</span> { <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>author</span> =&gt; <span class="String"><span class="String">'</span>Carlos Brando<span class="String">'</span></span> }
b <span class="Keyword">=</span> [ <span class="String"><span class="String">'</span>title = ?<span class="String">'</span></span>, <span class="String"><span class="String">'</span>Edge Rails<span class="String">'</span></span> ]

<span class="LibraryObject">Post</span>.<span class="FunctionName">merge_conditions</span>(a, b)
<span class="Comment"><span class="Comment">#</span> =&gt; &quot;(\&quot;posts\&quot;.\&quot;author\&quot; = 'Carlos Brando') AND (title = 'Edge Rails')&quot;</span>
</pre>

<p>Note that the <strong>conditions</strong> always get combined with <strong>AND</strong>.</p>

<h2> Defining how validates_length_of should function</h2>

<p>The <strong>validates_length_of</strong> is one of many validation methods in <strong>ActiveRecord</strong>. This particular method is for making sure that the value stored in a given database column has a certain length. It lets you specify a maximum length, a minimum length, an exact length, or even a range of lengths.</p>

<p>"Length," however, is relative. When we say "length" these days we are talking about the number of characters in the text. But imagine a case where you have a form field in which the limit is not defined by the number of characters, but by the number of words, such as, "Write a paragraph with at least 100 words." (I think a better example would be "Submit a comment with no more than 100 words.") Imagine a page where the user must submit an essay, for example.</p>

<p>Before Rails 2.2, our only option would be to create a custom validation method, but now you can personalize <strong>validates_length_of</strong> using the <strong>:tokenizer</strong> option. The following example resolves the aforementioned problem:</p>

<pre class="mac_classic">validates_length_of <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>essay</span>,
                    <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>minimum</span> =&gt; <span class="Number">100</span>,
                    <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>too_short</span> =&gt; <span class="String"><span class="String">&quot;</span>Sua redação deve ter no mínimo %d palavras.<span class="String">&quot;</span></span>),
                    <span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>tokenizer</span> =&gt; lambda {|<span class="Variable">str</span>| str.<span class="FunctionName">scan</span>(<span class="String"><span class="String">/</span></span><span class="String"><span class="StringInterpolation">\w</span>+</span><span class="String"><span class="String">/</span></span>) }
</pre>

<p>This is just one example of what you can do with this new option. In addition to this, you can use it to count only the number of digits, the times a certain word was used, etc.</p>

<h1> ActiveSupport</h1>

<p>Active Support is a collection of useful classes and default libraries extensions which were considered useful for Ruby on Rails Applications.
(wikipedia)</p>

<h1> ActiveResource</h1>

<p>ActiveResource is a layer responsible by the client side implementation of RESTful systems. Through ActiveResource is possible to consume RESTful services by using objects that work like a proxy for remote services.</p>

<h1> ActionPack</h1>

<p>Comprises ActionView (visualization generation for end user, like HTML, XML, JavaScript, and etc) and ActionController (business flow control)
(adapted from wikipedia)</p>

<h1> ActionController</h1>

<p>ActionController is the layer responsible by receiving web requests and taking decisions of what is going to be run and rendered or to redirect the request to another action.
An Action is defined as public methods within controllers which are automatically available through routes.</p>

<h1>ActionView</h1>

<p>ActionView is the layer responsible by the generation of the viewable interface visible to users through conversion of ERB templates.</p>

<h1> Railties</h1>

<h1> Rake Tasks, Plugins and Scripts</h1>

<h1> Prototype and script.aculo.us</h1>

<h1> Ruby 1.9</h1>

<h1> Debug</h1>

<h1> Bugs and Fixes</h1>

<h1> Additional Information</h1>

<h1> CHANGELOG</h1>

	</div>

	<div class="white_page"></div>
	<div class="white_page"></div>
	
	<div class="backcover"></div>
</body>
</html>
